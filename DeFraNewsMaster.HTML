<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8" />
    <title>DeFra News Master</title>
    <style>
        body, html { 
            margin: 0; padding: 0; height: 100%; width: 100%; 
            overflow: hidden; 
            background: #fcfcfc; 
        }

        #viewer {
            border: none;
            width: 100vw;
            height: 100vh;
            background-color: transparent;

            /* Cubic-bezier zorgt voor een 'zachte landing' van het artikel */
            transition: transform var(--fade-speed, 0.8s) cubic-bezier(0.23, 1, 0.32, 1), 
                        opacity var(--fade-speed, 0.8s) ease-in-out;
            transform: translateX(0);
        }

        .slide-prepare {
            transition: none !important;
            transform: translateX(100%) !important;
            opacity: 0;
        }

        #article-nav {
            position: absolute;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 12px;
            z-index: 10000;
        }

        .article-dot {
            width: var(--pill-width, 60px);
            height: 8px;
            background: var(--pill-bg-color, rgba(230, 125, 34, 0.36));
            border-radius: 4px;
            overflow: hidden;
            position: relative;
            transition: background 0.4s ease;
        }

        .article-dot.active::after {
            content: '';
            position: absolute;
            left: 0; top: 0; height: 100%; width: 0%;
            background: var(--pill-active-color, #e67e22);
            animation: articleProgress linear forwards;
            animation-duration: var(--duration, 30s);
        }

        @keyframes articleProgress {
            from { width: 0%; }
            to { width: 100%; }
        }

        .article-dot.completed {
            background: var(--pill-completed-color, #e67e22);
            opacity: 1;
        }
    </style>
</head>

<body>
    <div id="article-nav"></div>
    <iframe id="viewer" src="DeFraNewsViewerTemplate.HTML"></iframe>

    <script>
        // --- MASTER CONFIGURATIE ---
        const MASTER_CONFIG = {
            displayTime: 45*1000,            //Time per newsArticle in milliseconds
            fadeSpeed: 2.8,                 //Fade speed between articles in seconds
            transitionType: "slide", 
            pillWidth: "60px",
            pillActiveColor: "#e67e22",
            pillCompletedColor: "#e67e22",
            pillBackgroundColor: "#e67d225c"
        };

        const params = new URLSearchParams(window.location.search);
        const playlistUrl = params.get('list');

        let articles = [];
        let index = 0;
        let isFirstRun = true;
        let timerStarted = false;
        const viewer = document.getElementById('viewer');

        //  Initialize CSS variables based on MASTER_CONFIG
        document.documentElement.style.setProperty('--fade-speed', MASTER_CONFIG.fadeSpeed + 's');
        document.documentElement.style.setProperty('--pill-width', MASTER_CONFIG.pillWidth);
        document.documentElement.style.setProperty('--pill-bg-color', MASTER_CONFIG.pillBackgroundColor);
        document.documentElement.style.setProperty('--pill-active-color', MASTER_CONFIG.pillActiveColor);
        document.documentElement.style.setProperty('--pill-completed-color', MASTER_CONFIG.pillCompletedColor);

        async function loadPlaylist() {
            if (!playlistUrl) return;
            
            try {
                console.log("--- START PLAYLIST CHECK ---");
                const res = await fetch(playlistUrl + (playlistUrl.includes('?') ? '&' : '?') + "t=" + Date.now());
                const data = await res.json();
                
                const nu = new Date();
                console.log("Huidige lokale tijd:", nu.toLocaleString());

                const rawArticles = data.articles || [];

                articles = rawArticles.filter(a => {
                    // Browser interpreteert '2026-01-28T13:22:00' nu correct als lokale tijd
                    const start = a.start ? new Date(a.start) : new Date(0);
                    const end = a.end ? new Date(a.end) : new Date(8640000000000000);
                    
                    const isGeldig = nu >= start && nu <= end;
                    
                    console.log(`[${isGeldig ? 'LIVE' : 'SKIP'}] ${a.title}`);
                    if (nu < start) console.log(`   -> Start pas om: ${start.toLocaleString()}`);
                    if (nu > end) console.log(`   -> Verlopen op: ${end.toLocaleString()}`);

                    return isGeldig;

                    
                });

                articles.sort((a, b) => {
                    const dateA = new Date(a.start || 0);
                    const dateB = new Date(b.start || 0);
                    return dateB - dateA; 
                });

                console.log("Aantal artikelen live:", articles.length);
                console.log("--- EINDE PLAYLIST CHECK ---");

                if (articles.length > 0) {
                    renderArticleNav();
                    if (!window.timerStarted) {
                        window.timerStarted = true;
                        index = 0;
                        play();
                    }
                } else {
                    showFallback();
                }
            } catch (e) {
                console.error("Fout bij laden playlist:", e);
            }
        }

        function showFallback() {
            articles = [{
                title: "DEFRANEWS MASTER",
                subtitle: "STATUS: ONLINE",
                content: "Er zijn momenteel geen actuele nieuwsberichten.\n\nControleer de data in SharePoint.",
                images: [] 
            }];
            renderArticleNav();
            document.getElementById('article-nav').innerHTML = '<p style="color:#e67e22; font-family:sans-serif; font-size:14px; font-weight:bold;">GEEN ACTUELE BERICHTEN</p>';
            if (!window.timerStarted) {
                window.timerStarted = true;
                index = 0;
                play();
            }
        }

        function play() {
            if (articles.length === 0) return;
            
            const art = articles[index];

            document.querySelectorAll('.article-dot').forEach((dot, i) => {
                dot.classList.remove('active');
                dot.classList.toggle('completed', i < index);
                if (i === index) {
                    void dot.offsetWidth; 
                    dot.style.setProperty('--duration', (MASTER_CONFIG.displayTime / 1000) + 's');
                    dot.classList.add('active');
                }
            });

            if (isFirstRun) {
                isFirstRun = false;
                updateViewerContent(art);
            } else {
                viewer.classList.add('slide-prepare');
                updateViewerContent(art);
            }

            index = (index + 1) % articles.length;

            if (index === 0) {
                window.timerStarted = false; 
                setTimeout(loadPlaylist, MASTER_CONFIG.displayTime);
            } else {
                setTimeout(play, MASTER_CONFIG.displayTime);
            }
        }

        function updateViewerContent(art) {
            viewer.src = "DeFraNewsViewerTemplate.HTML?v=" + Date.now();
            
            window.onmessage = (e) => {
                if (e.data === 'READY') {
                    viewer.contentWindow.postMessage({
                        title: art.title,
                        subtitle: art.subtitle, // Nu direct gemapt op JSON key
                        content: art.content,   // Nu direct gemapt op JSON key
                        date: art.start || '',
                        authors: art.authors || 'Redactie Dekkers-Fransen',
                        images: art.images || [],
                        displayTime: MASTER_CONFIG.displayTime
                    }, '*');
                    
                    setTimeout(() => {
                        viewer.style.opacity = "1";
                        viewer.classList.remove('slide-prepare');
                    }, 100); 
                }
            };
        }

        function renderArticleNav() {
            const nav = document.getElementById('article-nav');
            nav.innerHTML = '';
            articles.forEach((_, i) => {
                const dot = document.createElement('div');
                dot.className = 'article-dot';
                dot.id = 'dot-' + i;
                nav.appendChild(dot);
            });
        }

        if (playlistUrl) loadPlaylist();
    </script>
</body>
</html>