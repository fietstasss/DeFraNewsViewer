<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8" />
    <title>DeFra News Master</title>
    <style>
        body, html { 
            margin: 0; padding: 0; height: 100%; width: 100%; 
            overflow: hidden; 
            /* Achtergrondkleur aangepast naar ViewerTemplate grijs/wit */
            background: #fcfcfc; 
        }

        #viewer {
            border: none;
            width: 100vw;
            height: 100vh;
            background-color: transparent;
            /* Cubic-bezier zorgt voor een 'zachte landing' van het artikel */
            transition: transform var(--fade-speed, 0.8s) cubic-bezier(0.23, 1, 0.32, 1), 
                        opacity var(--fade-speed, 0.8s) ease-in-out;
            transform: translateX(0);
        }

        /* Zet het nieuwe artikel klaar buiten het scherm (rechts) */
        .slide-prepare {
            transition: none !important;
            transform: translateX(100%) !important;
            opacity: 0; /* Verberg het iframe terwijl de content herlaadt */
        }

        #article-nav {
            position: absolute;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 12px;
            z-index: 10000;
        }

        .article-dot {
            width: var(--pill-width, 60px);
            height: 8px;
            background: var(--pill-bg-color, rgba(230, 125, 34, 0.36));
            border-radius: 4px;
            overflow: hidden;
            position: relative;
            transition: background 0.4s ease;
        }

        .article-dot.active::after {
            content: '';
            position: absolute;
            left: 0; top: 0; height: 100%; width: 0%;
            background: var(--pill-active-color, #e67e22);
            animation: articleProgress linear forwards;
            animation-duration: var(--duration, 30s);
        }

        @keyframes articleProgress {
            from { width: 0%; }
            to { width: 100%; }
        }

        .article-dot.completed {
            background: var(--pill-completed-color, #e67e22);
            opacity: 1;
        }
    </style>
</head>

<body>
    <div id="article-nav"></div>
    <iframe id="viewer" src="DeFraNewsViewerTemplate.HTML"></iframe>

    <script>
        // --- MASTER CONFIGURATIE (DE KNOPPEN) ---
        const MASTER_CONFIG = {
            displayTime: 25000,
            fadeSpeed: 2.8,
            transitionType: "slide", 
            pillWidth: "60px",
            pillActiveColor: "#e67e22",
            pillCompletedColor: "#e67e22",
            pillBackgroundColor: "#e67d225c"
        };

        const params = new URLSearchParams(window.location.search);
        const playlistUrl = params.get('list');

        let articles = [];
        let index = 0;
        let isFirstRun = true;
        let timerStarted = false;
        const viewer = document.getElementById('viewer');

        // Initialiseer CSS variabelen op basis van MASTER_CONFIG
        document.documentElement.style.setProperty('--fade-speed', MASTER_CONFIG.fadeSpeed + 's');
        document.documentElement.style.setProperty('--pill-width', MASTER_CONFIG.pillWidth);
        document.documentElement.style.setProperty('--pill-bg-color', MASTER_CONFIG.pillBackgroundColor);
        document.documentElement.style.setProperty('--pill-active-color', MASTER_CONFIG.pillActiveColor);
        document.documentElement.style.setProperty('--pill-completed-color', MASTER_CONFIG.pillCompletedColor);

        async function loadPlaylist() {
            if (!playlistUrl) return;
            try {
                const res = await fetch(playlistUrl + (playlistUrl.includes('?') ? '&' : '?') + "t=" + Date.now());
                const data = await res.json();
                const now = new Date();
                now.setHours(0,0,0,0);

                articles = (data.articles || []).filter(a => {
                    const start = a.start ? new Date(a.start) : null;
                    const end = a.end ? new Date(a.end) : null;
                    if (start) start.setHours(0,0,0,0);
                    if (end) end.setHours(23,59,59,999);
                    return (!start || start <= now) && (!end || end >= now);
                });

                if (articles.length > 0) {
                    renderArticleNav();
                    if (!window.timerStarted) {
                        window.timerStarted = true;
                        play();
                    }
                }
            } catch (e) {
                console.error("Fout bij laden playlist", e);
            }
        }

        function play() {
            if (articles.length === 0) {
                window.timerStarted = false;
                return;
            }
            
            const art = articles[index];

            // Update de pill-navigatie onderin
            document.querySelectorAll('.article-dot').forEach((dot, i) => {
                dot.classList.remove('active');
                dot.classList.toggle('completed', i < index);
                if (i === index) {
                    void dot.offsetWidth; 
                    dot.style.setProperty('--duration', (MASTER_CONFIG.displayTime / 1000) + 's');
                    dot.classList.add('active');
                }
            });

            if (isFirstRun) {
                isFirstRun = false;
                updateViewerContent(art);
            } else {
                // Zet het iframe direct rechts buiten beeld (met opacity 0 voor laden)
                viewer.classList.add('slide-prepare');
                
                // Terwijl het iframe rechts buiten beeld 'onzichtbaar' herlaadt, 
                // blijft de achtergrondkleur van de body zichtbaar.
                updateViewerContent(art);
            }

            index = (index + 1) % articles.length;

            if (index === 0) {
                window.timerStarted = false; 
                setTimeout(loadPlaylist, MASTER_CONFIG.displayTime);
            } else {
                setTimeout(play, MASTER_CONFIG.displayTime);
            }
        }

        function updateViewerContent(art) {
            viewer.src = "DeFraNewsViewerTemplate.HTML?v=" + Date.now();
            
            window.onmessage = (e) => {
                if (e.data === 'READY') {
                    viewer.contentWindow.postMessage({
                        title: art.title,
                        subtitle: art.subtitle || art.category,
                        content: art.content || art.message,
                        date: art.start || '',
                        authors: art.authors || 'Redactie Dekkers-Fransen',
                        images: art.images || (art.image ? [art.image] : []),
                        displayTime: MASTER_CONFIG.displayTime  //Required for the TemplateViewer to split up the images according to the artibleslide time.
                        
                    }, '*');
                    
                    // Zodra de template READY zegt, maken we hem zichtbaar en schuiven we hem in
                    setTimeout(() => {
                        viewer.style.opacity = "1";
                        viewer.classList.remove('slide-prepare');
                    }, 100); 
                }
            };
        }

        function renderArticleNav() {
            const nav = document.getElementById('article-nav');
            nav.innerHTML = '';
            articles.forEach((_, i) => {
                const dot = document.createElement('div');
                dot.className = 'article-dot';
                dot.id = 'dot-' + i;
                nav.appendChild(dot);
            });
        }

        if (playlistUrl) loadPlaylist();
    </script>
</body>
</html>