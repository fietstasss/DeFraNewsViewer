<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <title>DeFra News Master</title>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; background: #000; }
        iframe { border: none; width: 100vw; height: 100vh; }

        #viewer { 
            border: none; 
            width: 100vw; 
            height: 100vh; 
            transition: opacity 0.8s ease-in-out; /* Dit zorgt voor de vloeiende overgang */
            opacity: 1;
        }
        .fade-out { opacity: 0 !important; }

        /* Container helemaal onderaan het scherm */
        .bottom-progress-container {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 4px; /* Subtiele hoogte */
            background: rgba(0, 0, 0, 0.2);
            z-index: 9999;
        }

        /* De bewegende oranje balk */
        .bottom-progress-bar {
            width: 0%;
            height: 100%;
            background: #e67e22; /* DeFra Oranje */
            box-shadow: 0 0 8px rgba(230, 126, 34, 0.6);
        }

        /* De animatie-class */
        .animate-bottom-progress {
            animation: slideProgress linear forwards;
        }

        @keyframes slideProgress {
            from { width: 0%; }
            to { width: 100%; }
        }

        /* De Fade-overgang voor het hele iframe */
        #viewer { 
            border: none; 
            width: 100vw; 
            height: 100vh; 
            transition: opacity 0.8s ease-in-out; 
        }
        .fade-out { opacity: 0 !important; }
    </style>
</head>
<body>
    <!-- Progress bar -->
    <div class="bottom-progress-container">
        <div id="bottom-progress-bar" class="bottom-progress-bar"></div>
    </div>

    <iframe id="viewer" src="DeFraNewsViewerTemplate.HTML"></iframe>


    <script>
    const params = new URLSearchParams(window.location.search);
    const playlistUrl = params.get('list');
    const displayTime = 30000; // 30 seconden per bericht
    
    let articles = [];
    let index = 0;
    const viewer = document.getElementById('viewer');

    async function loadPlaylist() {
        try {
            const res = await fetch(playlistUrl + (playlistUrl.includes('?') ? '&' : '?') + "t=" + Date.now());
            const data = await res.json();
            
            const now = new Date();
            now.setHours(0,0,0,0); // Reset tijd voor zuivere datumcheck

            articles = (data.articles || []).filter(a => {
                const start = a.start ? new Date(a.start) : null;
                const end = a.end ? new Date(a.end) : null;
                if (start) start.setHours(0,0,0,0);
                if (end) end.setHours(23,59,59,999);

                return (!start || start <= now) && (!end || end >= now);
            });

            if (articles.length > 0) {
                // Alleen play() starten als er nog geen timer loopt
                if (index === 0 && !window.timerStarted) {
                    window.timerStarted = true;
                    play();
                }
            }
        } catch (e) { 
            console.error("Fout bij laden playlist", e); 
        }
    }

    function play() {
        if (articles.length === 0) return;
        const art = articles[index];
        const progressBar = document.getElementById('bottom-progress');

        // --- OPVANGER VOOR SLECHTS 1 ARTIKEL ---
        if (articles.length === 1) {
            // Reset alleen de balk voor de visuele timer
            progressBar.classList.remove('animate-progress');
            void progressBar.offsetWidth; 
            progressBar.style.animationDuration = (displayTime / 1000) + 's';
            progressBar.classList.add('animate-progress');

            // Check na 30 seconden alleen of er intussen nieuwe artikelen zijn
            setTimeout(loadPlaylist, displayTime);
            return; // Stop hier, we gaan niet faden of herladen
        }

        // --- LOGICA VOOR MEERDERE ARTIKELEN (FADE & WISSEL) ---
        viewer.classList.add('fade-out');
        progressBar.classList.remove('animate-progress');
        void progressBar.offsetWidth;

        setTimeout(() => {
            viewer.src = "DeFraNewsViewerTemplate.HTML?v=" + Date.now();
            
            window.onmessage = (e) => {
                if (e.data === 'READY') {
                    viewer.contentWindow.postMessage({
                        title: art.title,
                        subtitle: art.subtitle || art.category,
                        content: art.content || art.message,
                        date: art.start || '',
                        authors: art.authors || 'Redactie Dekkers-Fransen',
                        images: art.images || (art.image ? [art.image] : [])
                    }, '*');
                    
                    viewer.classList.remove('fade-out');
                    progressBar.style.animationDuration = (displayTime / 1000) + 's';
                    progressBar.classList.add('animate-progress');
                }
            };
        }, 800);

        index = (index + 1) % articles.length;
        
        if (index === 0) {
            setTimeout(loadPlaylist, displayTime);
        } else {
            setTimeout(play, displayTime);
        }
    }

    if (playlistUrl) loadPlaylist();
</script>
</body>
</html>